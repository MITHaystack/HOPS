%
% the meat of the thing
%
% a counter for consecutive numbering and \reqid are defined in shortcuts.
%

\section{Testable Requirements}
\label{sec:testable}

This section enumerates specific requirements that we plan to meet via explicit
tests.
Note that there are many untestable ``desires'' or ``goals''; these are
discussed in then next section (\Sec~\ref{sec:desires}).  Consequently,
potential tests that address such things do not appear in this section.
These issues are more fully addressed in the design document (\cite{design}).

\acs{HOPS} is currently in the version 3.x series; the new code will
begin with the 4.x series, and to distinguish the two flavors, (in code
and otherwise) we shall use \acs{MHO} to specifically refer to the latter.

Broadly speaking, the refactoring of \acs{HOPS} into \acs{MHO} is driven by
two overarching desires:

\begin{itemize}
\item Everything currently possible in \ac{HOPS} should remain possible in \acs{MHO}.
(We plan to validate this goal using many of the existing software tests)

\item \acs{MHO} should be easier to use than \acs{HOPS}.
(The decision to add a Python scripting layer, similar to CASA, partly addresses this).
 
\item \acs{MHO} shall support the required expansion of stations, baselines, and 
and bandwidth expected for the ngEHT.

\end{itemize}


The requirements defined in this section 
are partitioned into subsections according to how they are likely to be executed.
The first section deals with short automated tests
(\Sec~\ref{sec:auto}, \ie~these that that may be executed
in a nightly build), software tests that may be run at specific
juctions (\Sec~\ref{sec:regress}, \ie~regression tests),
and tests that are procedural, requiring human interaction
(\Sec~\ref{sec:procedure}, \ie~\ac{GUI} tests).%
\geomargin{In addition to these requirements, there are a few additional
geodetic requirements which are captured outside the ngEHT effort.}
Details of the testing process are to be found in the coverage
and testing document (\cite{cover}).

The requirements in this document are numbered with a prefix
according to the type of test that may be used to validate them:
A for automated tests, S for software testable, P for procedural.
The desire and goals are prefixed with D for desire and
F for future-proofing.


\subsection{Automated Testable Requirements}
\label{sec:auto}

The following are essential design requirements that shall be validated with a
``check'' script (shell, Python, or similar). The current \acs{HOPS} 
incorporates many scripts of this sort, which are used during the compile and
installation steps to verify the installation was successful, and during nightly 
builds to verify that daily updates to the code base have not broken any 
functionality. Existing unit tests within \ac{HOPS} will be ported into the new 
\ac{MHO} code set.

In addition to check scripts, unit tests shall be used for all code fragements, 
and shall cover all code.

%\subsubsection{General Requirements}
%\label{sec:genreq}
\begin{description}
\reqid{A} \ac{MHO} should support up to
    \TBD~30 stations and \TBD~435 baselines.
  \reqex[input required]{\ac{MHO} requires upper bounds merely to verify that
    it supports ``more than enough''}
    
\reqid{A} the number of \acsp{channel} may exceed 64 and should
    have no practical limit.
  \reqex[input required]{\ac{MHO} requires an upper bound merely to implement
    with some sensible channel labelling scheme}%
    %\footnote{using \acs{Unicode} for channel labels would certainly
    %be unbounded, but might be challenging for some to type.}

%\reqid{A} Use \acsu{unit} tests for all code.
%  \reqex{every code fragment will have a \texttt{test\_} module}
%
%\reqid{A} Unit tests should \acsu{cover} all code.
%  \reqex{every code fragment will have a \texttt{test\_} module}
\end{description}

The following existing tests currently exist in \ac{HOPS}
and can be ported to pass in \ac{MHO} as well.
\FIXME[This list is not currently well-ordered.
The tests need to be reworded into ``requirement'' form.
The requirements should have ``rationale'', ``explanation'',
``comment'' or some other clarification as appropriate]
% find . -name Makefile.am -print \
% -exec sed '/TESTS[^_].*=/,/^$/!d' {} \; -print | sed 's/^/% /' |
% grep -v PROGRAM

\begin{description}
% ./vex2xml/Makefile.am
\reqid{A} every function should provide useful
    \verb+--help+ and \verb+--version+ responses (with zero exit status)
    to behave as conventional \acs{GNU/Linux} applications.
  \reqex{This should be implemented with a 
    standard argument parsing library, and should respond helpfully
    on bad command-line syntax. \FIXME[what is the current test for
    this functionality?]}
    
\reqid{A} \ac{MHO} shall maintain a \acsu{VEX2XML} tool which converts 
\acs{VEX} to \acs{XML}, for \acs{VEX} version 1.5.
    \reqex{\texttt{chk\_v2v.sh} is a test that verifies that this tool,
    developed for \acsu{ALMA}, performs against a dozen separate
    captured \acs{VEX} files.}

% ./sub/dfio/Makefile.am
\reqid{A} If the non-compressed form of the \acs{Mk4} fringe file will be 
supported, we require that the results of fourfit (captured in the fringe plot)
be identical to results from the compressed version.
\reqex{\texttt{test\_compress} is an existing test of the \acs{PostScript} 
compression used in the \acs{Mk4} fringe file format. This requirement will likely 
disappear - we will save plots directly in PDF format, and save data in a
file. No more parsing postscript files for fringe results!}

\end{description}

The following requirements are related to the ``A-suite'' tools alist, aedit,
and adump.  The command-line interface for these tools shall be wrapped 
in Python in \acs{MHO}.

\begin{description}

\reqid{A} the \acs{alist} program should provide valid \acs{A-list}
    files in versions 5, 6 and any version \TBD~7.
    (\texttt{chk\_alist.sh} currently does this for versions 5 and 6. Version
    7 shall provide greater flexibility, with user-defined columns.)

\reqid{A} the \acs{adump} program shall provide valid ASCII text
    representations of columns of data from an \acs{A-list} of version
    5, 6 or any version \TBD~7.
    (\texttt{chk\_adump.sh} currently does this for versions 5 and 6.)

\reqid{A} the \acs{aedit} program should process versions 5, 6 and
    any version \TBD~7 \acs{A-list} files with respect to flagging,
    selecting, summarizing and generating new output \acs{A-list}.
    (the \texttt{chk\_aedit.sh} currently makes a pass through many
    of these)

%\reqid{A} the \acs{Python}ic replacement module for these three current
%    applications, is must fulfill the same requirement.

                    
% ./data/ae_testdata/Makefile.am
\reqid{A} \ac{MHO} shall maintain the performance of \acs{aedit} version
5 (used for geodesy) and 6 (used for EHT).
performance consistency. \TBD A discussion of post-6 version alist should
appear in the specifications document.
	\reqex{Currently, \texttt{chk\_fsumm.sh} performs such a test with captured 
	\acs{A-list} data.}

%\reqid{A} \acs{aedit} performance consistency on version 6 and
%    any version \TBD~7 should be maintained.
%    \FIXME[a discussion of a post-6 version should appear in the specification]
    

%\reqid{A} \FIXME[what does this test test, actually]
%    (\texttt{test\_mk4fringe} a test related to the uncompress
%    or compressed storage of \acs{Mk4} fringe files)
%
%\reqid{A} \FIXME[what does this test]
%    (\texttt{chk\_baselines.sh})



\end{description}

%\subsection{Changes to post processing tools for fringe plots.}
%This section will outline to the components of HOPS that are affected by the HOPS refactoring effort.
The following requirements describe wrappers and tools
 in HOPS for post-processing and examination of the fringe results.
They shall be maintained in MHO. 


\begin{description}
% ./postproc/fourmer/Makefile.am
\reqid{A} \acs{MHO} shall maintain a test which checks that the \acs{fourmer} 
tool relabels channels when it combines two sub-bands.
\reqex{This is currently performed by \texttt{test\_new\_chan\_id}}
  
        \reqid{A} the \acs{fringex} program should continue to explore and report
      on regions of search space around fringes as it does currently.
      (the \texttt{chk\_fringex.sh} exists to verify this in \acs{HOPS})

  \reqid{A} the ``average'' capability, implemented by \ac{average}
      used in concert with \ac{fringex} to subdivide explore and average
      fringes shall be preserved in an equivalent implementation.
      (the \texttt{chk\_average.sh} program does this for the existing
      \ac{average} application, but the piping mechanism is cumbersome
      and should be re-implemented in more easily used (and likely more
      efficient) C/C++ or \ac{Python} application.)

  \reqid{A}
      \texttt{chk\_avefix.sh}
  \reqid{A} there should be a test to verify \acs{cofit} functionality
      (\texttt{chk\_cofit.sh} currently verifies this)
  \reqid{A} there should be a test to verify \acs{search} functionality
      (\texttt{chk\_search.sh} currently does a search on a captive
      data set)
  \reqid{A} there should continue to be a functional \acs{fourmer} tool
      to assemble separately correlated frequency sub-bands.
      (\texttt{chk\_fourmer.sh} currently does this for a
      captive two 512-MHz bands.  A test to cover an extension
      to current \acs{EHT} 2-GHz bands should be build and maintained.)

\reqid{A} the ability to explore fringes (as is currently done with
    the combination of \ac{fringex}, \ac{average} and search must be
    preserved.  Scripting to make this easier must be available in
    \ac{Python}.
  \reqex{The \texttt{chk\_frmrsrch.sh} script executes such a
    case.}

\end{description}


\begin{description}

\reqid{A} the \ac{MHO} suite must provide mechanisms to preserve
    unmolested, the input correlator output data.
  \reqex[explanation]{%
    Disk space is cheaper these days; a \acs{PERL} script,
    \texttt{hops\_data\_links.pl} exists to manage symbolic links to
    analysis files some working directory (separate) from the original
    correlator output directory.  A script, \texttt{chk\_hdlinks.sh},
    verified this capability in \ac{HOPS}, and a similar mechanism
    should be provided in \ac{MHO}.}
\reqid{A} it should be possible to automatically discard correlator
    \acsp{AP} with small weights.
  \reqex{When data is poorly recorded, the correlation product is the
    result of less data than it should be, leading to incorrect results.
    The ability to flag such input should not be arduous.  The
    \ac{HOPS} script \texttt{chk\_min\_weight.sh} currently tests this
    capability.}
\reqid{A} \ac{MHO} should have the ability to flag some list of frequency
    intervals.
  \reqex{This is needed when \acs{RFI} or calibration tones signals are
    present.  In \ac{MHO} \texttt{chk\_notches.sh} verifies this.}
\reqid{A} \ac{MHO} should have the ability to automatically flag data
  \reqex{The \ac{HOPS} capability is tested by \texttt{chk\_flagging.sh}}

\reqid{A} Every data type written to disk in \ac{MHO} shall be 
    amenable to human-comprehensible examination as is done in \ac{HOPS}
    by the \texttt{\ac{CorAsc2}} program.
  \reqex{For the \ac{HOPS} \ac{fourfit} program, this is verified
    by \texttt{chk\_ff\_dump.sh}, for \ac{A-list} data, this is
    provided by \ac{adump}, or some combination of \acs{awk}, \acs{sed}
    and \acs{grep}.}
% \reqid{D} Data import/export to/from ASCII. (Export to or import data
%     from a human readible format.)

\reqid{A} Provide library access to \ac{LSF} methods
  \reqex{Both \acs{Python} and \acs{GSL} have these.}
\reqid{A} Implement an algorithm for solving for station-based quantities
    from baseline based quantities as a global fringe fitter.
  \reqex{This is new for \acs{MHO}}

\reqid{A} \ac{fourfit} should have the ability to do complex bandpass.
  \reqex{This is a new capability that might well be prototyped in the
    existing \ac{HOPS} package.  ``complex'' refers to both amplitude
    and phase variation of the receiver frequency response.  \ac{HOPS}
    already has rather sophisticated phase calibration handling.%
    \geomargin{the \acs{EHT} does not use tone generators, so most of
    that is only useful for geodetic systems which do}
    The ``manual'' phase calibrations already handle the phase variation
    from between \acsp{channel}.  \ac{HOPS} has no amplitude adjustment
    capability.  The desire is for a more flexible
    arrangment that is not limited by channel boundaries.}
\reqid{A} Provide a method to solve for complex bandpass
  \reqex{This method should accept some set of scans and stations and
    solve, using a \acs{LSF} method for per-station bandpass solutions}
\reqid{A} Provide a method to apply bandpass corrections
  \reqex{after correction, the amplitude on scans other than the ones
    used to calculate the bandpass should improve}

\reqid{A} Python wrappers for the new \acs{MHO} data objects must be
    provided.
  \reqex{The existing wrappers for the \acs{Mk4} data types in \ac{HOPS}
    do not need to be preserved, although we shall most likley do so.}
\end{description}

\FIXME[should have tests for other common control constructs]

In addition to the above tests, data from a variety of experiments
has been captured and are routinely refringed as part of the
\ac{HOPS} build ``check'' process.  Data from two of
these are packaged with the \ac{HOPS} distribution:
% ./data/ff_testdata/Makefile.am
\begin{description}
\reqid{A} \texttt{chk\_ff\_2836.sh} a canonical S--X geodetic experiment
\reqid{A} \texttt{chk\_ff\_3365.sh} an early \ac{EHT} session suitable for
    testing \ac{fourmer}
\end{description}
Both of these tests exercise the basic fringe search and reduction
that \ac{fourfit} was built to do and have been the basis of standard
regression for \ac{HOPS} and distribution validation.   Additional tests
with other captured data sets are discussed in the next section.

Some additional tests extant in \ac{HOPS} should not be needed in
\ac{MHO}; these are listed for reference in \App~\ref{sec:obsolete}.

\subsection{Software-Testable Requirements}
\label{sec:regress}

It is anticipated that each of these tests will be captured by a
script that may be executed on a regular basis, possibly requiring
user intervention.  For example, when run in an interactive mode,
\ac{fourfit} displays fringe plots which require a human to acknowledge
that they have in fact been displayed.  (One can test the generation of
the plot without a human, but the display mechanics require visual
inspection.)

\begin{description}
% ./sub/dfio/copypage/Makefile.am
\reqid{S} \texttt{fplot\_test} a test that the \ac{ghostscript} copypage
    command works as expected.  This requires a human to verify that
    \ac{ghostscript} properly display a page.
\reqid{S} \ac{aedit} experiment summary plot test.  This requires a
    human to verify that the summary is displayed, and that clicking
    on a scan-baseline-pol point produces the appropriate fringe plot.
\reqid{S} \ac{aedit} quantity with time display plot.  This requires
    a human to verify that the desired data are shown, and that it
    is possible to flag (discard) points.
\reqid{S} \FIXME[more, most likely]
\end{description}

Additional scans have been captured with fringe tests captured
in the \ac{HOPS} development system.  (That is, the tests exist,
but the data is not included in the distribution tarball.)

% ./data/ff_testdata/Makefile.am
\begin{description}
\reqid{S} verify that experiment 2843 fringes consistently.
  \reqex{currently done with \texttt{chk\_ff\_2843.sh} in \ac{HOPS}}
\reqid{S} verify that experiment 3372 fringes consistently.
  \reqex{currently done with \texttt{chk\_ff\_3372.sh} in \ac{HOPS}}
\reqid{S} verify that experiment 3413 fringes consistently.
  \reqex{currently done with \texttt{chk\_ff\_3413.sh} in \ac{HOPS}}
\end{description}

Additional test data has been captured from the (very) successful
2017 \ac{EHT} observations.  Fringing of these scans has not yet
been incorporated into \ac{HOPS} testing, but shall form the basis
of regression for \ac{MHO}.  \FIXME[elaborate]

It is anticipated that for these a mechanism shall be provided
so that they human need merely acknowledge success, failure or
make a note of issues.

\subsection{Procedure-Testable Requirements}
\label{sec:procedure}

This section includes items that may be directly verified in a quasi-automated
fashion which may involve a human.  That is, there will be a procedure for the
human to execute with a documented report to be generated.

\begin{description}
\reqid{P} It should be possible to make 2D plots of the type
    currently possible within \texttt{\ac{aedit}} of \ac{HOPS}.
  \reqex{These are plots such as \ac{SNR} with time broken out
    by baseline with separate symbols per target.  It is not
    possible, but should be possible to combine several baselines
    into a composity plot.}
\reqid{P} It should be possible to make 3D visualization plots
  \reqex{\ac{search} makes contour plots, but a 3D visualization
    of amplitude with delay and delay-rate would be useful.}

\reqid{P} Regression tests of 2017 or 2018 data samples
  \reqex{Among the so-called ``golden'' scan data which has been
    captured for \acs{DiFX} regression testing, there are scans
    which can be refringed and \acs{A-list} manipulated and compared
    with previous results.  As set that is sufficient to guarantee
    consistency with published results is required.  Reprocessing
    the entire 2017 and 2018 data is not required.}

    \FIXME[more]

\end{description}

Currently captured for \ac{DiFX} regression testing are the first 20 s
on the following experiment-release-subband-doy-hhmm samples:
\begin{verbatim}
e17d05-7-hi-095-0839 e17d05-7-lo-095-0839 e17d05-7-pc-095-0839
e17b06-7-hi-096-0750 e17b06-7-lo-096-0750 e17b06-7-pc-096-0750
e17c07-7-hi-097-1303 e17c07-7-lo-097-1303 e17c07-7-pc-097-1303
e17a10-7-hi-100-0725 e17a10-7-lo-100-0725 e17a10-7-pc-100-0725
e17e11-7-hi-101-0322 e17e11-7-hi-101-0803 e17e11-7-lo-101-0322
e17e11-7-lo-101-0803 e17e11-7-pc-101-0322 e17e11-7-pc-101-0803
\end{verbatim}
``lo'' and ``hi'' refer to the ``b3'' and ``b4'' sub-bands of the
64 \acs{Gbps} (2018 and onwards) frequency setup; ``pc'' refers to polconverted,rather than the mixed polarization correlation products.

\TBC\FIX[---is this a sufficient set?]

These or other scans could also be captured for full scan duration and
segmented at some interval, but it is not clear that this is necessary.

The existing package has a number of dependencies which are becoming
a challenge to maintain---\acs{PGPLOT} is such an example.  Ideally
\acs{MHO} should be installable and usable without any dependencies.
(However, we do not require that full functionality necessarily follows
from a computer lacking such support.)  The build machinery should test
for the presence of these packages and make appropriate accomodation for
the Linux distribution. Note that we will only support three major distributions,
Ubuntu, Fedora, and NixOS. Testing will be done frequently for only these
three distributions. There are no plans to officially support other 
distributions, Mac OSX, or Windows.

%
% apparently the description environment breaks the math here, so
% relative math adjustments will be needed if these are reordered
%
\newsavebox{\xpgplot}
  \addtocounter{req}{1}
  \sbox{\xpgplot}{\textbf{{P-\thereq}}}
\newsavebox{\xfftwthree}
  \addtocounter{req}{1}
  \sbox{\xfftwthree}{\textbf{{P-\thereq}}}
\addtocounter{req}{-2}
%
\begin{description}
\reqid{P} \acs{PGPLOT} should not be required
  \reqex{At a minimum, \acs{Python}ic equivalents can be constructed.}
\reqid{P} \acs{FFTW3} should not be required
  \reqex{Not that DFT support to handle the non-power of two channels
    used in the \acs{EHT} is needed.}
\reqid{P} \acs{GSL} should not be required
  \reqex{There are slower \acs{Python} library replacements for most
    things.}
\end{description}
\FIXME[more of these?]

\section{General (not directly testable) Desires}
\label{sec:desires}

This section covers items that are verifiable by inspection (or analysis
or discussion).  It is subdivided into a section on goals of the current
project which we expect to reach by the end of the project, and a section
on future-proofing.

\subsection{Current Desires}
\label{sec:currentdesires}

\begin{description}
%\reqid{D} Everything currently possible in \ac{HOPS} should remain
%    possible in \ac{MHO}.
%  \reqex{The existing tests mostly cover this.}
%\reqid{D} \ac{MHO} should be easier to use than \ac{HOPS}.
%  \reqex{The decision to add a \acs{Python} scripting layer (similar
%    to \acs{CASA} addresses this.}
\reqid{D} The \acs{Mk4} data types are stored \acs{bigendian}; the new types
    should be stored to \acs{littleendian} to reflect the current processing
    reality.
  \reqex{It is unlikely that any processor manufacturer will introduce
    a bigendian processor in the future---that hardware war is over.}
\reqid{D} Refactor the Single Band Delay \ac{SBD},
    Multi Band Delay \ac{MBD} and Delay Rate \ac{DR} algorithm to
    make it more modular (and amenable to variations on the method).
  \reqex{The current loop in \acs{fourfit} includes a loop over \acs{TEC}
    as well, which makes 4 loops.  For spectral line data at
    high frequencies the ionosphere is unimportant and
    where \ac{MBD} impossible, this is two loops too many}.

\reqid{D} Expand the functionality of \acs{alist} to allow for more data
    analysis/visualization options.
  \reqex{\acs{Python} seems a likely solution.}
    % those are both commercial(Like Looker or Tableau?)
\reqid{D} Implement data visualization tools in Python for \acs{fourfit}
\reqex{the \acs{HOPS} version of \acs{fourfit} provides a fixed fringe summary    plot.  Often one notes some issue requiring some examination, or at
    least something that bears viewing with an expanded scale, but there
    is not easy path to such examination at present.}

\reqid{D} Replace the existing \acs{fourfit} control file with
    a \acs{Python}-based control file that has the same exact functionality.
  \reqex{the existing control file should continue to be supported, but
    new functionality might only exist in the \acs{MHO} toolset.}

\reqid{D} Support \acs{VEX} 2.0 and make it compatible with the
    \acs{VEX2XML} parser tool.
  \reqex{it is not clear that \acs{VEX} 2.0 will ever exist, but it does
    allow the \acs{EHT} to correctly capture its frequency setups and
    recording allocations.  Such support would need to exist in \acs{DiFX},
    and it is not clear that any of its developers care to do this work.}

\reqid{D} Benchmarking and performance analysis should be augmented
    with a more sophisticated tools.
  \reqex{The existing \acs{HOPS} package supports a \texttt{account}
    library that does rudimentary profiling.  Introducing \texttt{gprof}
    into some specific build tests, should be straightforward and help
    to optimize fringing.}

\reqid{D} Refactor how alist files are handled to make one line
    summaries of every fringe plot but do it in Python.
\reqid{D} Refactor alist, aedit, and fourfit to be compatible with \ac{HOPS}.

%\reqid{D} Rename the Mk4 data type number series.
%\reqid{D} Refactor all existing algorithms in to new Python libraries
%    that run C or C++ code under the hood.

\reqid{D} Support mm-VLBI work with spectral line sources (narrow sources).
  \reqex{The existing \acs{HOPS} code assumes a continuum.}

\reqid{D} Pulsar folding functionality should be enabled
  \reqex{But is not required}

\end{description}

\subsection{Future-Proofing}
\label{sec:future}

For every required package (beyond the historically, generally
available \ac{GNU/Linux} packages) the code should be structured so
that it is relatively straightforwards to port to a new package with
similar functionality.

\begin{description}
\reqid{F} The \acs{PGPLOT} package has long been obsolete, and any replacement
    package could follow the same fate.  Thus all plotting package calls
    need to be managed with an interface that allows porting to equivalent
    packages.
  \reqex{Addressed above as \usebox{\xpgplot}}
\reqid{F} The \ac{FFT} calls should be wrapped so that packages other than
    \ac{FFTW3} can be used.
  \reqex{Addressed above as \usebox{\xfftwthree}}
\end{description}

\FIXME[are there other dependencies we forgot to mention here?]

%
% eof
%
