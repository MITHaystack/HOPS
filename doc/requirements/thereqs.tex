%
% the meat of the thing
%
% a counter for consecutive numbering and \reqid are defined in shortcuts.
%

\section{Requirements}
\label{sec:testable}

%This section enumerates specific requirements that we plan to meet via explicit
%tests.
%Some
%Note that there are many untestable ``desires'' or ``goals''; these are
%discussed in then next section (\Sec~\ref{sec:desires}).  Consequently,
%potential tests that address such things do not appear in this section.
%These issues are more fully addressed in the design document (\cite{design}).
%
%Requirements shall generally be paired with explicit demonstrations that they
%have been met.
%


%The requirements defined in this section
%are partitioned into subsections according to how they are likely to be executed.
%The first section deals with short automated tests
%(\Sec~\ref{sec:auto}, \ie~these that that may be executed
%in a nightly build), software tests that may be run at specific
%juctions (\Sec~\ref{sec:regress}, \ie~regression tests),
%and tests that are procedural, requiring human interaction
%(\Sec~\ref{sec:procedure}, \ie~\ac{GUI} tests).%
%\geomargin{In addition to these requirements, there are a few additional
%geodetic requirements which are captured outside the ngEHT effort.}
%Details of the testing process are to be found in the coverage
%and testing document (\cite{cover}).

The requirements defined in this section are loosely organized by functionality.
Requirements are numbered with a prefix according to
the type of test that will be used to validate them.  These prefixes are:
%%% EDIT: \item[A,] etc. to avoid the awkward-looking lonely comma
\begin{description}
[align=left, labelwidth=0.0cm, leftmargin=1cm]
\item[A,] for automated tests. These are requirements
that shall be validated with a ``check'' script (in shell, Python, or similar).
These scripts can be executed during installation steps to verify the
installation was successful,
or in a nightly build to verify that daily updates have not broken any
functionality. Existing tests within HOPS3 will be ported into the new
HOPS4 code set.

\item[S,] for software-testable. These are more complicated tests such as
regression tests that may be run at specific points in development. It is
anticipated that each of these tests will be implemented by a script, and a report provided.

\item[P,] for procedural tests that require human interpretation (\eg~
validating the display mechanics of a figure). These tests shall have
explicit instructions for the user and the results shall be recorded.

\item[D,] for desires. These are not true requirements, but are general
design goals for which testing does not apply.  They are listed here as
they are inputs the the development plan.

%\item[F,] for future-proofing guidelines to ensure HOPS4 is useful beyond
%the immediate horizon. For every required package (beyond the historically,
%generally available GNU/Linux packages) the code should be structured
%so that it is relatively straightforward to port to a new package with
%similar functionality. Again, no formal test report for these shall be made.

\end{description}

Details of the testing process will be made available in the coverage
and testing document \cite{cover}.
%%% EDIT: my preference here would be to site the document as
%%% EDIT: being ``in preparation''.  We know the title and authors.

%\FIX[Note: many of these requirements were imported from existing check
%scripts and need explicit definitions. The tests need to be reworded into 
%``requirement'' form. The requirements should have ``rationale'', ``explanation'',
%``comment'' or some other clarification as appropriate]




%\subsection{Automated Testable Requirements}
%\label{sec:auto}
%
%The following are essential design requirements that shall be validated with a
%``check'' script (shell, Python, or similar). The current \acs{HOPS}
%incorporates many scripts of this sort, which are used during the compile and
%installation steps to verify the installation was successful, and during nightly
%builds to verify that daily updates to the code base have not broken any
%functionality. Existing unit tests within \ac{HOPS} will be ported into the new
%\ac{MHO} code set.
%
%In addition to check scripts, unit tests shall be used for all code fragements,
%and shall cover all code.



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{General Requirements}
\label{sec:genreq}

The following requirements describe essential design features.

\begin{description}

\reqid{S} HOPS4 shall provide effectively equivalent results for any output that HOPS3 was capable of producing.
\reqex{A set of historical DiFX output has been captured and HOPS4 results will 
be periodically compared to HOPS3 results on observables that HOPS3 supports to ensure consistency.}

\reqid{A} HOPS4 shall have no practical limit on the number of stations,
baselines, channels, or accumulation periods other than which is imposed by the
memory limitations of the computer hardware on which it is run.

%%% EDIT: it think it is useful to leave these red

\reqid{A} HOPS4 shall support at least \FIX[30] stations and 435 baselines.
  \reqex[input required]{HOPS4 requires an upper bound merely to verify that
    it supports ``more than enough'' stations.}

\reqid{A} HOPS4 shall explicitly test functionality with at least \FIX[128] 
channels and shall not impose a limit on the number of channels.
  \reqex[input required]{HOPS4 requires an upper bound merely to implement
    with some sensible channel labeling scheme and verify that the requirement is satisfied.}
    %\footnote{using \acs{Unicode} for channel labels would certainly
    %be unbounded, but might be challenging for some to type. However,
    %there is no real need to limit channel labels to a single-character.}

\reqid{A} HOPS4 shall support a (raw station data) bit depth of \FIX[2] bits.
  \reqex[input required]{Support for 1-bit is available in HOPS3,
    and hooks for other bit depths will be provided, but the code for other
    depths will require development in order to ensure proper normalization
and treatment of noise statistics, etc.}

\reqid{A} Every library (C/C++) or module (python) shall have a corresponding
test suite to verify expected functionality. This may include, but is not limited
to, unit tests (for individual classes/functions) with the appropriate test
cases to be determined.


\end{description}

The existing package has a number of dependencies which are becoming
a challenge to maintain---\acs{PGPLOT} is such an example.  Ideally
HOPS4 should be installable and usable without any dependencies.
(However, we shall not require that the software provide complete functionality
on a computer lacking such optional dependencies.) The build machinery should test
for the presence of these packages and make appropriate accommodation for
the Linux distribution. Note that we will only support three major distributions,
Debian/Ubuntu, Fedora, and NixOS. Testing will be done frequently for only these
three distributions. There are no plans to officially support other distributions,
Mac OSX, or Windows.

\begin{description}

\reqid{P} HOPS4 shall operate without loss of functionality in the absence of
FFTW3, and/or GSL, with the understanding that performance (runtime) might be
affected. 
\reqex{For example FFT calls should be wrapped so that other
packages or native code may be used instead.}

\reqid{P} \acs{PGPLOT} shall not be required for basic functionality (\eg~
fringe-fitting). HOPS4 shall include the same plotting functionality as HOPS3, 
but using standard modern packages (\eg~Python, Matplotlib). The user should 
be able to substitute their own plotting routines as desired, and \acs{PGPLOT} 
will be optionally supported for some plotting/display options.
\reqex{The \acs{PGPLOT} package has been out of maintenance for a long time,
and any replacement package could follow the same fate. Thus all plotting package calls need to be 
managed within an optional plugin which leaves core functionality unaffected by 
its presence. At a minimum, plotting functionality similar to the current fringe-plots
shall be constructed with a set of independent Python tools.}

\end{description}

%The following existing tests currently exist in \ac{HOPS}
%and can be ported to pass in \ac{MHO} as well.
%\FIXME[This list is not currently well-ordered.]
% find . -name Makefile.am -print \
% -exec sed '/TESTS[^_].*=/,/^$/!d' {} \; -print | sed 's/^/% /' |
% grep -v PROGRAM



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{File I/O and Supported File Types}
\label{sec:ioreq}

\begin{description}

\reqid{A} HOPS4 shall support input from the DiFX \cite{deller2007difx,deller2011difx} correlator (in Swinburne format).

% ./vex2xml/Makefile.am
\reqid{A} every application should provide
    \verb+--help+ and \verb+--version+ responses (with zero exit status)
    to behave as conventional \acs{GNU/Linux} applications.
  \reqex{Command-line arguments should be implemented with a
    standard argument parsing library, and should respond helpfully
    on bad command-line syntax.}

\reqid{A} HOPS4 shall support input from \acs{VEX} version 1.5.\footnote{\acs{VEX} 1.5
is the only extant working file format for VLBI experiment description, however, there does
exist a VEX 2.0 specification which is not currently in active use but may be adopted at any time.}


\reqid{A} All plotting tools provided in HOPS4 shall have the ability to save the image to 
a standard graphics format.
\reqex{HOPS4 has the desire to support as much plotting flexibility as possible, including plot formats (fonts, panels, etc).}

% ./sub/dfio/Makefile.am
%\reqid{A} If the non-compressed form of the \acs{Mk4} fringe file will be
%supported, we require that the results of fourfit (captured in the fringe plot)
%be identical to results from the compressed version.
%\reqex{\texttt{test\_compress} is an existing test of the \acs{PostScript}
%compression used in the \acs{Mk4} fringe file format. \FIXME[This requirement will likely
%disappear - we will save plots directly in PDF format, and save data in a
%file. No more parsing postscript files for fringe results!]}

\reqid{D} All new native data types (to be detailed in the specification document)
shall be stored \acs{littleendian}.

\reqid{D} HOPS4 shall provide an application to support export of native
data types to a \TBD~archival format (\eg~HDF5).

\reqid{D} HOPS4 shall incorporate a C-library to interface with the legacy 
\acs{Mk4} data types (stored \acs{bigendian}) in their current form for 
testing purposes, and in order to access archived data. 
%HOPS4 
%will not, however, be required to support any new functionality.

\end{description}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{A-tools}
\label{sec:areq}

The following requirements are related to the ``A-suite'' tools \acs{alist}, \acs{aedit},
and \acs{adump}.  The command-line interface for these tools shall be wrapped
in Python in HOPS4 and shall support alist file version 6\footnote{Version 6 is the standard for the \ac{EHT}, and a version 7 format seems
sensible but is not yet required.  If in detailing the specifications
a version 7 (or 8, \etc) emerges, these requirements transfer
to the those version(s) as well.]}.

%%% EDIT: replaced:
%%% 5 \& 6 \footnote{%
%%% If there is an \acs{A-list} version 7, these shall apply to version 7 as well.
%%% A discussion of a TDB version 7 \acs{alist} shall be included in the
%%%  specifications document.}.

%\vspace{12pt} \EDIT[DROPPING ALL MENTION of 5 and geodesy.]


\begin{description}

\reqid{A} The \acs{alist} program shall generate valid \acs{A-list} files in 
version 6.

%\reqex{\texttt{chk\_alist.sh} currently does this for versions 5 and 6.}

%\reqid{A} the \acs{alist} program shall provide a new ASCII
% A-list format (version 7) that will allow the data columns will be user-defined.

\reqid{A} The \acs{adump} program shall provide valid ASCII text representations 
of columns of data from an \acs{A-list} of version 6.
%\reqex{\texttt{chk\_adump.sh} currently does this for versions 5 and 6.}

\reqid{A} The \acs{aedit} program shall process version 6 \acs{A-list} 
files with respect to flagging, selecting, summarizing and generating a new 
output \acs{A-list}.
%\reqex{the \texttt{chk\_aedit.sh} currently makes a pass through many of these}

%\reqid{A} the \acs{Python}ic replacement module for these three current
%    applications (alist, aedit, adump), must fulfill the same requirements.

% ./data/ae_testdata/Makefile.am

%%% EDIT: drop this here:
%%% \reqid{A} HOPS4 shall maintain the performance of \acs{aedit} version 5 (for 
%%% geodesy) and 6 (for EHT).
%%%


%\reqex{Currently, \texttt{chk\_fsumm.sh} performs such a test with captured 
%\acs{A-list} data.}

%\reqid{S} \acs{aedit} experiment summary plot test.  This requires a
%    human to verify that the summary is displayed, and that clicking
%    on a scan-baseline-pol point produces the appropriate fringe plot.
%\reqex{\FIXME[need to elaborate on the requirement that is being tested]}
%
%\reqid{S} \acs{aedit} quantity with time display plot.  This requires
%    a human to verify that the desired data are shown, and that it
%    is possible to flag (discard) points.
%\reqex{\FIXME[need to elaborate on the requirement that is being tested]}
%
%\reqid{D} Expand the functionality of \acs{alist} to allow for more data
%
%    analysis/visualization options.
%  \reqex{\acs{Python} seems a likely solution, also Looker or Tableau.}
%
%\reqid{D} Refactor how alist files are handled to make one line
%    summaries of every fringe plot but do it in Python.

%\reqid{D} Refactor alist, aedit, and fourfit to be compatible with \ac{HOPS}.
%\reqex{\FIXME[need to elaborate on this desire]}

%\reqid{A} \acs{aedit} backwards compatibility on version 5, 6 and
%    any version \TBD~7 shall be maintained.

%\reqid{A} \FIXME[what does this test test, actually]
%    (\texttt{test\_mk4fringe} a test related to the uncompress
%    or compressed storage of \acs{Mk4} fringe files)
%
%\reqid{A} \FIXME[what does this test]
%    (\texttt{chk\_baselines.sh})

\end{description}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Post Processing and Fringe Plots}
\label{sec:postprocreq}
%This section will outline to the components of HOPS that are affected by the HOPS refactoring effort.

The following requirements describe wrappers and tools in HOPS3 for 
post-processing and examination of the fringe results. They shall be
maintained in HOPS4.

%\FIXME[Same as above: re-write these as specific requirements, move check script details to the
%coverage and testing document.]

\begin{description}
% ./postproc/fourmer/Makefile.am
\reqid{A} HOPS4 shall maintain the \acs{fourmer} tool, which shall properly 
relabel channels when it combines two sub-bands.
%\reqex{This is currently performed by \texttt{test\_new\_chan\_id}.}

\reqid{A} The \acs{fringex} program shall retain existing functionality to rotate
fringes with respect to fourfit fringe solutions.
%\reqex{The \texttt{chk\_fringex.sh} exists to verify this in HOPS3.}

\reqid{A} The ``average'' capability, implemented by \acs{average} used in 
concert with \acs{fringex} to subdivide explore and average fringes, shall be 
preserved with equivalent functionality.
%\reqex{The \texttt{chk\_average.sh} program tests this for the existing 
%\acs{average} application, but the piping mechanism is cumbersome and should be
%re-implemented in a more easily used (and likely more efficient) C/C++ or 
%\acs{Python} application.}

\reqid{A} The functionality of the program \acs{cofit} shall be preserved.
%\reqex{\texttt{chk\_cofit.sh} currently verifies this.}

%%% ``there''
\reqid{A} The current functionality of the program \acs{search} shall be 
preserved.
%\reqex{\texttt{chk\_search.sh} currently verifies this by performing a search on
%a captive data set.}

%%% EDIT: duplicate
%%% \reqid{A} There shall continue to be a functional \acs{fourmer} tool to assemble
%%% separately correlated frequency sub-bands.
%\reqex{\texttt{chk\_fourmer.sh} currently does this for a captive two 512-MHz 
%bands. We will need to build and maintain a test to cover an extension to 
%current \acs{EHT} 2-GHz bands.}

\reqid{A} The ability to explore fringes (as is currently done with the 
combination of \acs{fringex}, \acs{average} and search must be preserved. 
HOPS4 shall support \acs{Python} scripting to aid the user in searching 
fringe space.
%\reqex{The \texttt{chk\_frmrsrch.sh} script executes such a case.}

\reqid{P} It should be possible to make 2D plots of the type currently possible 
within \texttt{\acs{aedit}} of HOPS3.
\reqex{These are plots such as \acs{SNR} with time broken out by baseline with 
separate symbols per target. It is not currently possible, but should be possible 
to combine several baselines into a composite plot.}

\reqid{P} It should be possible to make 3D visualization plots.
\reqex{\acs{search} makes contour plots, but a 3D visualization of amplitude 
with delay and delay-rate would be useful.}

\reqid{P} HOPS4 shall implement interactive visualization tools in \acs{fourfit}.
\reqex{The HOPS3 version of \acs{fourfit} provides a fixed fringe summary
plot. HOPS4 should have an interactive plotting capability to enable zooming
and viewing fourfit results with an expanded scale.}

\reqid{D} Replace the existing \acs{fourfit} control file with a 
\acs{Python}-based control file. Currently existing functionality shall be 
preserved. 
\reqex{The existing control file should continue to be supported. The new 
control file functionality will not likely be back-ported to HOPS3. Details of the control file design will be described in the Specifications document \cite{design}.}


\end{description}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Miscellaneous Requirements}
\label{sec:miscreq}

\begin{description}
    
\reqid{A} It shall be possible to automatically discard correlator 
\acs{AP} (integrations) with small weights.
\reqex{When data are poorly recorded, the correlation product will be the result 
of less data than it should be, leading to incorrect results. Flagging poorly recorded data segments is currently done in HOPS3 provided \acs{DiFX} properly notices the loss.}
%The HOPS3 script 
%\texttt{chk\_min\_weight.sh} currently tests this capability. In addition, 
%user-supplied ad-hoc flagging capability is tested by \texttt{chk\_flagging.sh}.}

\reqid{A} HOPS4 shall have the ability to flag data based on a user-supplied 
list (\eg~of frequency intervals with time in some flag file).
\reqex{This is needed especially when \acs{RFI} or calibration tones signals 
are present. Details of the flagging methods will be described in the Specifications document \cite{design}.}%  In HOPS3 \texttt{chk\_notches.sh} verifies this.}

\reqid{A} Every data type written to disk in HOPS4 shall be convertable to 
form that is amenable to human examination (e.g. ASCII or CSV), as is done in HOPS3 by the 
\texttt{\acs{CorAsc2}} program.
%\reqex{For the HOPS3 \acs{fourfit} program, this is verified by 
%\texttt{chk\_ff\_dump.sh}; for \acs{A-list} data, this is provided by \acs{adump},
%or some combination of awk, sed and grep.}

\reqid{A} HOPS4 shall implement an algorithm for solving for station-based 
quantities from baseline-based quantities as a global fringe fitter.
\reqex{This is new for HOPS.}

% I (DH) think this refers to converting delays from the basis of 
% baselines (between two stations) to the basis of individual stations,
% i.e. using sets of three (triangular) baselines to calculate the 
% delays at each station.

\reqid{A} The HOPS4 \acs{fourfit} shall have the ability to apply complex 
bandpass correction.
\reqex{This is a new capability that might well be prototyped in the existing 
HOPS3 package. Here ``complex'' refers to both amplitude and phase variation 
of the receiver frequency response. HOPS3 already has rather 
sophisticated phase calibration handling. \geomargin{the \acs{EHT} does 
not use tone generators, so most of that is only useful for geodetic systems 
which do} The ``manual'' phase calibrations already handle the phase 
variation from between \acsp{channel}.  HOPS3 has no amplitude adjustment 
capability.  The desire is for a more flexible arrangment that is not limited
by channel boundaries, and has the ability to correct either phase or amplitude or both.
Details of the bandpass correction methods will be described in the Specifications \& Design document \cite{design}.}

\reqid{A} HOPS4 shall provide a method to solve for complex bandpass corrections.
\reqex{This method should accept some set of scans and stations and solve, 
possibly using an \acs{LSF} method, for per-station bandpass solutions. Supporting
plots will be generated.}

\reqid{A} Python wrappers for the new HOPS4 data objects shall be provided.
\reqex{The existing wrappers for the \acs{Mk4} data types in HOPS3 do not 
need to be preserved, but it is a capability worth preserving.}


\reqid{D} The HOPS4 suite must provide mechanisms to preserve the correlator 
output data.
\reqex{A \acs{PERL} script, \texttt{hops\_data\_links.pl}, exists to manage 
symbolic links to analysis files in a working directory separate from the original 
correlator output directory.}
%A script, \texttt{chk\_hdlinks.sh}, verified this capability 
%in HOPS3, and a similar mechanism should be provided in HOPS4.}

\reqid{D} HOPS4 should preserve the the Single Band Delay, Multi Band Delay 
and Delay Rate search algorithm in its current form.
\reqex{Our desire is to make the algorithm modular, such that the user may (de)select search
dimensions. For example the current loop in in \acs{fourfit} includes a loop over \acs{TEC},
which is not needed at \acs{EHT} frequencies and could be ignored in \acs{EHT} analysis. 
Similarly, for spectral line data the multi-band delay is not meaningful.
The revised implementation should make it easier to develop and
introduce new algorithms.}.
%The current loop in \acs{fourfit} includes a loop over \acs{TEC}
%(which is not needed at \acs{EHT} frequencies), which makes 4 loops.  For spectral line data 
%\acs{MBD} is impossible, so there are two loops too many.



\reqid{D} Benchmarking and performance analysis should be augmented with 
a more sophisticated tools.
\reqex{The existing HOPS package supports a \texttt{account} library that does 
rudimentary profiling.  Introducing \texttt{gprof} into some specific build tests, 
should be straightforward and help to optimize fringing.}

\reqid{D} HOPS4 should support spectral-line VLBI.
\reqex{The existing HOPS code assumes a continuum.}

\reqid{D} HOPS4 should support pulsar folding with a user specified period or
ephemeris file with blanking.
%\reqex{This may be descoped.}

\reqid{D} HOPS4 should enable multi-threading or multi-processing for batch jobs.
\reqex{Parallelization is a strong desire, but the exact details of the 
implementation (particularly the requirements of threads vs processes) need to 
be carefully designed.}


\end{description}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%




%\subsection{Procedure-Testable Requirements}
%\label{sec:procedure}

%This section includes items that may be directly verified in a quasi-automated
%fashion which may involve a human.  That is, there will be a procedure for the
%human to execute with a documented report to be generated.






%
% apparently the description environment breaks the math here, so
% relative math adjustments will be needed if these are reordered
%
%\newsavebox{\xpgplot}
%  \addtocounter{req}{1}
%  \sbox{\xpgplot}{\textbf{{P-\thereq}}}
%\newsavebox{\xfftwthree}
%  \addtocounter{req}{1}
%  \sbox{\xfftwthree}{\textbf{{P-\thereq}}}
%\addtocounter{req}{-2}
%

%\FIXME[more of these?]

%\section{General (not directly testable) Desires}
%\label{sec:desires}

%\subsection{Current Desires}
%\label{sec:currentdesires}
%
%This section covers items that are verifiable by inspection (or analysis
%or discussion).  It is subdivided into a section on goals of the current
%project which we expect to reach by the end of the project, and a section
%on future-proofing.

%\begin{description}
%\reqid{D} Everything currently possible in \ac{HOPS} should remain
%    possible in \ac{MHO}.
%  \reqex{The existing tests mostly cover this.}
%\reqid{D} \ac{MHO} should be easier to use than \ac{HOPS}.
%  \reqex{The decision to add a \acs{Python} scripting layer (similar
%    to \acs{CASA} addresses this.}

%\reqid{D} Rename the Mk4 data type number series.
%\reqid{D} Refactor all existing algorithms in to new Python libraries
%    that run C or C++ code under the hood.

%\end{description}





%
% eof
%
